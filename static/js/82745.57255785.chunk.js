"use strict";(self.webpackChunkn2_station=self.webpackChunkn2_station||[]).push([[82745],{27786:(e,r,t)=>{t.d(r,{i3:()=>T,zO:()=>E});var n=t(35143),i=t(91967),s=t(54901),a=t(30726),o=t(46053),d=t(81806),l=(t(76460),t(47249),t(85842)),u=t(9392),c=t(55855),h=t(64465),p=t(82250),y=t(57481),m=t(34981),g=t(60586),w=t(50255),v=t(77730),_=t(16699);let f=class extends g.RW{constructor(e){super(e),this._glMaterials=null,this._produces=new Map,this._renderGeometries=new Map,this._vaoCache=null,this._drawParameters=new _.P,this._bufferWriter=null}get produces(){return this._produces}get numFeatures(){let e=0;return this._renderGeometries.forEach(r=>e+=r.numElements/6),e}get usedMemory(){let e=0;return this._renderGeometries.forEach(r=>{e+=r.vao.usedMemory}),e}initialize(){this._bufferWriter=this.material.createBufferWriter(),this.material.produces.forEach((e,r)=>{this._produces.set(r,r=>r!==m.V.Highlight&&r!==m.V.ShadowHighlight&&e(r))})}destroy(){this._glMaterials.dispose();const e=this._renderGeometries.keys();for(const r of e)this.removeRenderGeometry(r)}acquireTechniques(e){const r=this.material;if(!r.shouldRender(e))return null;const{output:t,bind:n}=e,i=r.produces.get(n.slot);if(null===i||void 0===i||!i(t))return null;if(t===m.V.Highlight||t===m.V.ShadowHighlight)return null;const s=this._glMaterials.load(e.rctx,n.slot,t);return null===s||void 0===s?void 0:s.beginSlot(n)}render(e,r){const t=this._renderGeometries;if(0===t.size)return;const{bind:n}=e,i=n.slot===v.N.OCCLUDER_MATERIAL||n.slot===v.N.TRANSPARENT_OCCLUDER_MATERIAL?n.slot:null,s=e.rctx;s.runAppleAmdDriverHelper(),s.bindTechnique(r,n,this.material.parameters);const a=r.program;for(const[o,d]of t)this._drawParameters.origin=d.localOrigin,a.bindDraw(n,this.material.parameters,this._drawParameters),r.ensureAttributeLocations(d.vao),s.bindVAO(d.vao),s.setPipelineState(r.getPipeline(!1,i)),s.drawArrays(r.primitiveType,0,d.numElements)}initializeRenderContext(e,r){this._glMaterials=new w.c(this.material,e.materials),this._vaoCache=e.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,(0,y.U)(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}addRenderGeometry(e,r,t){this.removeRenderGeometry(e);const n=this._vaoCache.newVao(r.data.byteLength);n.vertexBuffers.get("geometry").setSubData(new Uint8Array(r.data),0,0,r.data.byteLength);const i={localOrigin:t,vao:n,numElements:r.elementCount};return this._renderGeometries.set(e,i),i}removeRenderGeometry(e){const r=this._renderGeometries.get(e);null!=r&&(this._vaoCache.deleteVao(r.vao),this._renderGeometries.delete(e))}hasHighlightOptions(e){return!1}};(0,n._)([(0,o.MZ)({constructOnly:!0})],f.prototype,"material",void 0),f=(0,n._)([(0,l.$)("esri.views.3d.layers.graphics.pipeline.rendering.DirectRenderer")],f);var R=t(50346),b=(t(50076),t(66470)),x=t(3595),F=t(12062);let M=class{constructor(e){this._optionalFields=new Array,this._featureIdToInstanceIndex=new Map,this._disposeResourceHandles=new Array,this._lodRendererResources=null,this.layerUid=e.layerUid,this.view=e.view,this.sharedResources=this.view.sharedSymbolResources,this.scheduler=this.view.resourceController.scheduler}get numFeatures(){return this._featureIdToInstanceIndex.size}get usedMemory(){var e,r;const t=null===(e=this._lodRendererResources)||void 0===e?void 0:e.lodRenderer,n=null===t||void 0===t?void 0:t.symbol;return(null!==(r=null===n||void 0===n?void 0:n.computeUsedMemory())&&void 0!==r?r:0)+16*this._featureIdToInstanceIndex.size}destroy(){this._disposeResourceHandles.forEach(e=>e())}async doLoad(e,r,t){(0,d.A)("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(b.r.OBJECTANDLAYERIDCOLOR);const n=function(e,r){const t=r.levels.map(r=>{const t=r.components.map(r=>{const t=e(r.materialId);if(!function(e){return null!=e&&"materialType"in e&&"default"===e.materialType}(t))throw new Error("LodRenderer only supports DefaultMaterial");const n=new F.Rn(t,r.renderGeometryBuffer.data,r.renderGeometryBuffer.elementCount,r.boundingInfo);return new F.iC(n)});return new F.hr(t,r.minScreenSpaceRadius)});return new F.Fe(t)}(e=>r(e),e),i=this.view._stage,s=n.getMaterials();i.addMany(s),this._addDisposeResource(()=>i.removeMany(s));const a=n.getTextures();i.addMany(a),this._addDisposeResource(()=>{a.forEach(e=>e.unload()),i.removeMany(a)}),await Promise.all(a.map(e=>this.view._stage.schedule(()=>e.load(i.renderView.renderingContext),t))),(0,R.throwIfAborted)(t);const o=await this._createLodRenderer(n,t);this._lodRendererResources={lodRenderer:o,materials:s,textures:a}}addInstances(e){const r=this._lodRendererResources;if(null==r)return;const{featureIds:t,localTransforms:n,globalTransforms:i}=e,s=r.lodRenderer;if(null==s)return;const a=s.instanceData,o=t.length;for(let d=0;d<o;++d){const e=t[d],r=a.addInstance(),s=a.view,o=16*d;s.localTransform.copyFromTypedBuffer(r,n,o),s.globalTransform.copyFromTypedBuffer(r,i,o),a.updateModelTransform(r),a.setVisible(r,!0),this._featureIdToInstanceIndex.set(e,r)}}removeInstances(e){const r=this._lodRendererResources;if(null==r)return;const t=r.lodRenderer.instanceData,n=this._featureIdToInstanceIndex,i=e.length;for(let s=0;s<i;++s){const r=e[s],i=n.get(r);null!=i&&(t.removeInstance(i),n.delete(r))}}_addDisposeResource(e){this._disposeResourceHandles.push(e)}async _createLodRenderer(e,r){const t=this.view._stage,n={layerUid:this.layerUid,graphicUid:e=>1,notifyGraphicGeometryChanged:e=>1,notifyGraphicVisibilityChanged:e=>1},i=new x.L({symbol:e,optionalFields:this._optionalFields,metadata:n,shaderTransformation:null},this.scheduler);return i.slicePlaneEnabled=!1,this._addDisposeResource(()=>{t.removeRenderPlugin(i),i.destroy()}),await t.addRenderPlugin(i,r),i}};M=(0,n._)([(0,l.$)("esri.views.3d.layers.graphics.pipeline.rendering.LodRenderer")],M);var I=t(72900),S=t(83490),k=t(65131),O=t(84248),C=t(78992);let T=class extends i.default{constructor(e){super(),this.view=null,this.layerUid=null,this._renderGeometries=new Map,this._materials=new Map,this._directRenderers=new Map,this._lodRenderers=new Map,this.totalFeatures=0,this.view=e.view,this.layerUid=e.layerUid}initialize(){}destroy(){this.removeAllHandles(),this._lodRenderers.forEach(e=>e.destroy())}async executeRenderCommands(e){for(const r of e)switch(r.id){case"create-material":await this._createMaterial(r);break;case"create-direct-renderer":await this._createDirectRenderer(r);break;case"add-direct-renderer-geometry":await this._addDirectRendererGeometry(r),this._updateFeatureCount();break;case"remove-direct-renderer-geometry":await this._removeDirectRendererGeometry(r),this._updateFeatureCount();break;case"create-lod-renderer":await this._createLodRenderer(r);break;case"add-lod-instances":await this._addLodInstances(r),this._updateFeatureCount();break;case"remove-lod-instances":await this._removeLodInstances(r),this._updateFeatureCount()}}_updateFeatureCount(){let e=0;for(const r of this._directRenderers.values())e+=r.numFeatures;for(const r of this._lodRenderers.values())e+=r.numFeatures;this._set("totalFeatures",e)}get usedMemory(){let e=0;for(const r of this._directRenderers.values())e+=r.usedMemory;for(const r of this._lodRenderers.values())e+=r.usedMemory;return e}async _createMaterial(e){const{view:r}=this,{sharedSymbolResources:t}=r;if(null==t)throw new Error("No shared symbol resources found!");const{textures:n}=t,i=r.state.viewingMode===h.RT.Global;let o=null;switch(e.type){case"default":o=function(e,r,t){const n={usePBR:r.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:C.Bt,ambient:u.Un,diffuse:u.Un,hasSlicePlane:r.slicePlaneEnabled,castShadows:r.castShadows,offsetTransparentBackfaces:!r.isPrimitive};return function(e){var r;const t=null!==(r=e.opacity)&&void 0!==r?r:1,n=t<1;e.transparent=n,e.opacity=t,e.cullFace=n?S.s2.None:S.s2.Back}(n),r.screenSizePerspectiveEnabled&&(n.screenSizePerspective=e.screenSizePerspectiveSettings),n.externalColor=c.Un,n.isInstanced=!0,new k.$U(n,{spherical:t,doublePrecisionRequiresObfuscation:!0})}(t,{physicalBasedRenderingEnabled:!0,slicePlaneEnabled:!1,castShadows:!0,isPrimitive:!0,screenSizePerspectiveEnabled:!0,doublePrecisionRequiresObfuscation:r._stage.renderView.renderingContext.driverTest.doublePrecisionRequiresObfuscation.result},i);break;case"hud":{const[e,r]=E(n,i);this.addHandles([(0,s.hA)(()=>(0,a.Gz)(r))]),o=e}break;default:throw new Error("unable to create unknown material type ".concat(e.type))}this._materials.set(e.materialId,o)}_getMaterial(e){return this._materials.get(e)}async _createDirectRenderer(e){const r=e.materialId,t=this._getMaterial(r);if(null==t)throw new Error("material not found ".concat(r));const{view:n}=this,i=new f({material:t});this._directRenderers.set(r,i),n._stage.addRenderPlugin(i),n._stage.renderView.renderer.updateHasFlags()}async _addDirectRendererGeometry(e){const r=e.renderGeometryId,t=e.materialId;await this._removeDirectRendererGeometry({renderGeometryId:r});const n=this._directRenderers.get(t);if(null==n)return void console.error("no renderer assigned to provided material");const i=n.addRenderGeometry(r,e.renderGeometryBuffer,e.localOrigin);this._renderGeometries.set(r,{renderGeometry:i,materialId:t}),this.view._stage.renderView.requestRender()}async _removeDirectRendererGeometry(e){const r=e.renderGeometryId,t=this._renderGeometries.get(r);if(null==t)return;const n=t.materialId,i=this._directRenderers.get(n);null!=i?i.removeRenderGeometry(e.renderGeometryId):console.error("no renderer assigned to provided material")}async _createLodRenderer(e){const r=new M({view:this.view,layerUid:this.layerUid}),t=new AbortController;await r.doLoad(e.lodRenderGeometry,e=>this._getMaterial(e),t.signal),this._lodRenderers.set(e.lodRendererId,r)}async _addLodInstances(e){const r=this._lodRenderers.get(e.lodRendererId);if(null==r)throw new Error("no lod renderer assigned to provided lod renderer Id");r.addInstances(e.data)}async _removeLodInstances(e){const r=this._lodRenderers.get(e.lodRendererId);if(null==r)throw new Error("no lod renderer assigned to provided lod renderer Id");r.removeInstances(e.featureIds)}};function E(e,r){const t={anchorPosition:p.Zd.center,occlusionTest:!0,hasSlicePlane:!1,color:[1,0,0,1],outlineColor:[0,0,0,1],outlineSize:1,distanceFieldBoundingBox:I.PY};if(null!=e){const r=e.fromData("circle-icon",()=>(0,I.sZ)("circle"));t.textureId=r.texture.id,t.textureIsSignedDistanceField=!0,t.sampleSignedDistanceFieldTexelCenter=(0,I.ny)("circle")}return[new O.R(t,r),null]}(0,n._)([(0,o.MZ)({readOnly:!0})],T.prototype,"totalFeatures",void 0),T=(0,n._)([(0,l.$)("esri.views.3d.layers.graphics.pipeline.rendering.FeaturePipelineRenderManager")],T)},82745:(e,r,t)=>{t.d(r,{Feature3DPipeline:()=>b});var n=t(35143),i=t(50076),s=t(54901),a=t(30726),o=t(91291),d=t(68134),l=t(46053),u=(t(81806),t(76460),t(47249),t(85842)),c=t(14672),h=t(12016),p=t(76797),y=t(77725);let m=class extends o.A{constructor(e){super(e),this.schedule=null,this._workerUpdating=!0}get updating(){return this._workerUpdating}initialize(){this._workerHandle=new g(this.schedule,this);const{layer:e,viewSpatialReference:r,renderSpatialReference:t}=this;this.addResolvingPromise((async(n,i,s)=>{await e.load();const{fullExtent:a}=e;await this._workerHandle.invokeMethod("setup",{url:null!==(n=null===(i=e.parsedUrl)||void 0===i?void 0:i.path)&&void 0!==n?n:"",baseQuery:e.createQuery().toJSON(),viewSpatialReference:r.toJSON(),renderSpatialReference:t.toJSON(),viewingMode:this.viewingMode,objectIdField:e.objectIdField,capabilities:e.capabilities,timeInfo:null===(s=e.timeInfo)||void 0===s?void 0:s.toJSON(),fieldsIndex:e.fieldsIndex.toJSON(),fullExtent:null===a||void 0===a?void 0:a.toJSON()})})()),this.addHandles(this._workerHandle.on("notify-updating",e=>{let{updating:r}=e;this._workerUpdating=r}))}onTileTreeChange(e){let{added:r,removed:t}=e;if(0===r.length&&0===t.length)return;const n=r.map(w),i=t.map(w);this._workerHandle.invokeMethod("onTileTreeChange",{added:n,removed:i})}async executeQuery(e,r){const t=await this._workerHandle.invokeMethod("executeQuery",null===e||void 0===e?void 0:e.toJSON(),r),n=y.default.fromJSON(t);return this._ensureLayerOnFeatures(n),n}async executeQueryForIds(e,r){return await this._workerHandle.invokeMethod("executeQueryForIds",null===e||void 0===e?void 0:e.toJSON(),r)}async executeQueryForCount(e,r){return await this._workerHandle.invokeMethod("executeQueryForCount",null===e||void 0===e?void 0:e.toJSON(),r)}async executeQueryForExtent(e,r){const{count:t,extent:n}=await this._workerHandle.invokeMethod("executeQueryForExtent",null===e||void 0===e?void 0:e.toJSON(),r);return{count:t,extent:p.default.fromJSON(n)}}async executeQueryForLatestObservations(e,r){const t=await this._workerHandle.invokeMethod("executeQueryForLatestObservations",null===e||void 0===e?void 0:e.toJSON(),r),n=y.default.fromJSON(t);return this._ensureLayerOnFeatures(n),n}_ensureLayerOnFeatures(e){const{layer:r}=this;for(const t of e.features)t.layer=r,t.sourceLayer=r}};(0,n._)([(0,l.MZ)()],m.prototype,"updating",null),(0,n._)([(0,l.MZ)({constructOnly:!0})],m.prototype,"schedule",void 0),(0,n._)([(0,l.MZ)({constructOnly:!0})],m.prototype,"layer",void 0),(0,n._)([(0,l.MZ)({constructOnly:!0})],m.prototype,"viewSpatialReference",void 0),(0,n._)([(0,l.MZ)({constructOnly:!0})],m.prototype,"renderSpatialReference",void 0),(0,n._)([(0,l.MZ)({constructOnly:!0})],m.prototype,"viewingMode",void 0),(0,n._)([(0,l.MZ)({constructOnly:!0})],m.prototype,"dispatchRenderCommands",void 0),(0,n._)([(0,l.MZ)()],m.prototype,"_workerUpdating",void 0),m=(0,n._)([(0,u.$)("esri.views.3d.layers.graphics.pipeline.Feature3DPipelineWorkerHandle")],m);class g extends h.B{constructor(e,r){super("Feature3DPipelineWorker","setup",{},e,{strategy:"dedicated",client:r})}}function w(e){let{id:r,lij:t,extent:n}=e;return{id:r,lij:t,extent:n}}var v=t(27786),_=t(42123),f=t(65768),R=t(44513);let b=class extends o.A{constructor(e){super(e),this._renderer=null,this.graphicsQuery={queryForSymbologySnapping:(e,r)=>{throw new i.default("unsupported-symbology-snapping")},executeQuery:async(e,r)=>await this._workerHandle.executeQuery(e,r),executeQueryForIds:async(e,r)=>await this._workerHandle.executeQueryForIds(e,r),executeQueryForCount:async(e,r)=>await this._workerHandle.executeQueryForCount(e,r),executeQueryForExtent:async(e,r)=>await this._workerHandle.executeQueryForExtent(e,r),executeQueryForLatestObservations:async(e,r)=>await this._workerHandle.executeQueryForLatestObservations(e,r)},this.maximumNumberOfFeatures=1e3}initialize(){if("point"!==this.layerView.layer.geometryType)throw new i.default("unsupported-geometry-type","".concat(this.layerView.layer.geometryType," is not supported"));this.addResolvingPromise(this.setup())}destroy(){this.removeAllHandles(),this._workerHandle.destroy(),(0,a.pR)(this._renderer)}async setup(){const{layer:e,view:r}=this.layerView,{spatialReference:t,renderSpatialReference:n,resourceController:i}=r,s=r.state.viewingMode;if(this._renderer=new v.i3({view:r,layerUid:e.uid}),"feature"!==e.type)throw new Error("Only FeatureLayer is supported");const a=new m({schedule:e=>i.immediate.schedule(e),layer:e,viewSpatialReference:t,renderSpatialReference:n,viewingMode:s,dispatchRenderCommands:e=>this._renderer.executeRenderCommands(e)});this._workerHandle=await a.when(),this.addHandles([this.layerView.view.featureTiles.addClient(),(0,d.on)(()=>this.layerView.view.featureTiles.tiles,"change",e=>{this._workerHandle.onTileTreeChange(e)},{onListenerAdd:e=>this._workerHandle.onTileTreeChange({added:e.toArray(),removed:[]}),onListenerRemove:e=>this._workerHandle.onTileTreeChange({added:[],removed:e.toArray()})})])}get legendEnabled(){return!1}get hasAllFeatures(){return!1}get hasAllFeaturesInView(){return!1}get hasFullGeometries(){return!1}get symbologySnappingSupported(){return!1}get scaleVisibilitySuspended(){return!1}get suspendInfo(){return{}}get updating(){return this._workerHandle.updating}get dataUpdating(){return!1}get updatePolicy(){return R.q.ASYNC}get maximumNumberOfFeaturesExceeded(){return!1}get updatingProgressValue(){return 1}get usedMemory(){var e,r;return null!==(e=null===(r=this._renderer)||void 0===r?void 0:r.usedMemory)&&void 0!==e?e:0}get unloadedMemory(){return 0}get ignoresMemoryFactor(){return!0}get totalFeatures(){var e,r;return null!==(e=null===(r=this._renderer)||void 0===r?void 0:r.totalFeatures)&&void 0!==e?e:0}get performanceInfo(){const e=this.totalFeatures;return new c.X(new f.P(this.usedMemory,e,e,this.maximumNumberOfFeatures,0,null),e,e,this.maximumNumberOfFeaturesExceeded,"tiles","n/a")}get suspendResumeExtentMode(){return"computed"}forEachGraphic(e){}findGraphic(e){return null}highlight(e){return _.Wg}maskOccludee(e){return(0,s.hA)()}async whenGraphicBounds(e,r){return null}computeAttachmentOrigin(e,r){return null}elevationAlignPointsInFeatures(e,r){throw new i.default("unsupported-elevation-alignment")}async doRefresh(e){}setVisibility(e,r){}getMissingAttributesForFeature(e){return null}getHydratedGeometry(e){return null}};(0,n._)([(0,l.MZ)()],b.prototype,"layerView",void 0),(0,n._)([(0,l.MZ)()],b.prototype,"updating",null),(0,n._)([(0,l.MZ)()],b.prototype,"totalFeatures",null),b=(0,n._)([(0,u.$)("esri.views.3d.layers.graphics.pipeline.Feature3DPipeline")],b)}}]);
//# sourceMappingURL=82745.57255785.chunk.js.map